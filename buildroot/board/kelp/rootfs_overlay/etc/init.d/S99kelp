#!/bin/sh
#
# S99kelp â€” Kelp OS init script
#
# Silent boot: loads kernel module, starts gateway, no verbose output.
#

DAEMON=/usr/bin/kelp-gateway
MODULE=kelp
DEVICE=/dev/kelp
PIDFILE=/var/run/kelp-gateway.pid
LOGFILE=/var/log/kelp/kelp-gateway.log

case "$1" in
    start)
        # Create directories
        mkdir -p /var/log/kelp /var/run

        # Load kernel module (silent)
        if ! lsmod 2>/dev/null | grep -q "^${MODULE} "; then
            modprobe ${MODULE} 2>/dev/null || \
                insmod /lib/modules/$(uname -r)/extra/${MODULE}.ko 2>/dev/null
        fi

        # Wait for device node (max 3 seconds)
        TRIES=0
        while [ ! -c ${DEVICE} ] && [ ${TRIES} -lt 30 ]; do
            sleep 0.1
            TRIES=$((TRIES + 1))
        done

        # Start gateway daemon (silent)
        if [ -x ${DAEMON} ]; then
            start-stop-daemon -S -b -m -p ${PIDFILE} \
                -x ${DAEMON} -- -d >> ${LOGFILE} 2>&1
        fi
        ;;

    stop)
        if [ -f ${PIDFILE} ]; then
            start-stop-daemon -K -p ${PIDFILE} 2>/dev/null
            rm -f ${PIDFILE}
        fi
        if lsmod 2>/dev/null | grep -q "^${MODULE} "; then
            rmmod ${MODULE} 2>/dev/null
        fi
        ;;

    restart)
        "$0" stop
        sleep 1
        "$0" start
        ;;

    status)
        if [ -f ${PIDFILE} ] && kill -0 $(cat ${PIDFILE}) 2>/dev/null; then
            echo "kelp-gateway running (PID $(cat ${PIDFILE}))"
        else
            echo "kelp-gateway stopped"
        fi
        if lsmod 2>/dev/null | grep -q "^${MODULE} "; then
            echo "kelp.ko loaded"
            [ -f /proc/kelp/stats ] && cat /proc/kelp/stats
        else
            echo "kelp.ko not loaded"
        fi
        ;;

    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0
